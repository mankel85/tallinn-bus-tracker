<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸšŒ Tallinn Bus Tracker â€“ Ã•ilme Stop</title>
  <style>
    /* your existing CSSâ€¦ */
    /* (same as before) */
  </style>
</head>
<body>
  <div class="status-indicator status-loading" id="statusIndicator">â— Loading...</div>
  <div class="container">
    <div class="header">
      <h1>ğŸšŒ Tallinn Bus Tracker</h1>
      <div class="stop-name">ğŸ“ Ã•ilme Bus Stop</div>
      <div class="last-updated" id="lastUpdated">Last updated: Never</div>
    </div>
    <div class="controls">
      <button class="refresh-btn" onclick="refreshData()">ğŸ”„ Refresh Now</button>
      <label class="auto-refresh">
        <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
        Auto-refresh (30s)
      </label>
    </div>

    <!-- FOR DEBUGGING: raw JSON dump -->
    <pre id="rawDump" style="max-height:200px;overflow:auto;background:#f0f0f0;padding:10px;"></pre>

    <div class="bus-lines" id="busLines"></div>
  </div>

  <script>
    function formatTime(m){return m<=0?'Now':m===1?'1 min':m+' min';}
    function formatSched(d){return d.toLocaleTimeString('et-EE',{hour:'2-digit',minute:'2-digit'});}
    function updateStatus(s){
      const i=document.getElementById('statusIndicator');
      i.className='status-indicator status-'+s;
      i.textContent={'online':'â— Online','offline':'â— Offline','loading':'â— Loading...'}[s]||'â—';
    }
    function updateLastUpdated(){
      const n=new Date();
      document.getElementById('lastUpdated').textContent=
        'Last updated: '+n.toLocaleTimeString('et-EE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }

    async function fetchBusData(){
      updateStatus('loading');
      try {
        const stopId='oilme';
        const tgt=`https://transport.tallinn.ee/api/v1/stops/${stopId}/arrivals`;
        const proxy=`https://corsproxy.io/?${encodeURIComponent(tgt)}`;
        const r=await fetch(proxy);
        const json=await r.json();
        document.getElementById('rawDump').textContent=JSON.stringify(json,null,2);
        updateStatus('online');
        return transformData(json);
      } catch(e){
        console.error(e);
        updateStatus('offline');
        return null;
      }
    }

    function transformData(api){
      const out={};
      api.forEach(item=>{
        const ln=item.routeShortName,dir=item.direction===0?'inbound':'outbound';
        out[ln]=out[ln]||{inbound:{},outbound:{}};
        const arrs=(item.nextArrivals||[]).map(a=>{
          // use published timetableTime, fallback to expectedArrivalTime
          const iso=a.timetableTime||a.expectedArrivalTime;
          const sched=iso?new Date(iso):null;
          const liveMs=iso?new Date(iso).getTime():Date.now()+(a.timeToStation||0)*60000;
          const mins=Math.max(0,Math.round((liveMs-Date.now())/60000));
          return {scheduledTime:sched,actualMinutes:mins,delay:a.delayMinutes||0};
        });
        out[ln][dir]={destination:item.destinationName,arrivals:arrs};
      });
      return out;
    }

    function renderBusLines(data){
      const c=document.getElementById('busLines');
      if(!data||!Object.keys(data).length){
        c.innerHTML='<div class="no-data">No bus data available</div>';return;
      }
      let html='';
      Object.keys(data).forEach(ln=>{
        html+=`<div class="bus-line line-${ln}">
          <div class="line-header">
            <div class="line-number">${ln}</div>
            <div class="line-info"><h3>Line ${ln}</h3></div>
          </div>`;
        ['inbound','outbound'].forEach(dir=>{
          const d=data[ln][dir]||{};
          html+=`<div class="direction-section">
            <div class="direction-header">
              <span>${dir==='inbound'?'ğŸ™ï¸':'ğŸ '}</span>
              <span>${d.destination||'â€”'}</span>
            </div><div class="arrivals">`;
          (d.arrivals||[]).forEach(a=>{
            const sched=a.scheduledTime?`ğŸ“… ${formatSched(a.scheduledTime)}`:'';
            const dl=a.delay>0?`+${a.delay}min`:a.delay<0?`${a.delay}min`:'On time';
            html+=`<div class="arrival-item">
              <div class="arrival-time-main">${formatTime(a.actualMinutes)}</div>
              <div class="scheduled-time">${sched}</div>
              <div class="delay-status">${dl}</div>
            </div>`;
          });
          html+=`</div></div>`;
        });
        html+='</div>';
      });
      c.innerHTML=html;
    }

    let autoInt;
    async function refreshData(){
      renderBusLines(await fetchBusData());
      updateLastUpdated();
    }
    function toggleAutoRefresh(){
      const cb=document.getElementById('autoRefresh');
      if(cb.checked){autoInt=setInterval(refreshData,30000);refreshData();}
      else clearInterval(autoInt);
    }
    document.addEventListener('DOMContentLoaded',()=>{
      refreshData();updateStatus('online');
    });
  </script>
</body>
</html>

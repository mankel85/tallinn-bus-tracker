<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tallinn Bus Tracker – Õilme Stop</title>
  <style>
    /* (All of your existing CSS remains unchanged) */
    /* … */
  </style>
</head>
<body>
  <div class="status-indicator" id="statusIndicator">●</div>
  
  <div class="container">
    <div class="header">
      <h1>🚌 Tallinn Bus Tracker</h1>
      <div class="stop-name">📍 Õilme Bus Stop</div>
      <div class="last-updated" id="lastUpdated">Last updated: Never</div>
    </div>

    <div class="controls">
      <button class="refresh-btn" onclick="refreshData()">🔄 Refresh Now</button>
      <label class="auto-refresh">
        <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
        Auto-refresh (30s)
      </label>
    </div>

    <div class="bus-lines" id="busLines">
      <!-- Bus line data will be populated here -->
    </div>
  </div>

  <script>
    // Your existing helpers (formatTime, formatScheduledTime, getDelayStatus, etc.) remain here
    // …

    // 1) Replace generateMockData & fetchBusData with real fetch via AllOrigins
    async function fetchBusData() {
      updateStatus('loading');
      try {
        const stopId   = 'oilme';  // Õilme stop ID
        const target   = `https://transport.tallinn.ee/api/v1/stops/${stopId}/arrivals`;
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`;

        const res  = await fetch(proxyUrl);
        const data = await res.json();

        updateStatus('online');
        return transformTallinnData(data);

      } catch (err) {
        console.error('Fetch error:', err);
        updateStatus('offline');
        return null;
      }
    }

    // 2) Map the Tallinn API response into your app’s shape
    function transformTallinnData(apiData) {
      const result = {};
      apiData.forEach(item => {
        const line = item.routeShortName;    // e.g. "3", "16", etc.
        const dir  = item.direction === 0 ? 'inbound' : 'outbound';
        if (!result[line]) {
          result[line] = { inbound: {}, outbound: {} };
        }
        result[line][dir] = {
          destination: item.destinationName,
          arrivals: item.nextArrivals.map(a => ({
            scheduledTime: new Date(a.scheduledTime),
            actualMinutes: a.timeToStation,
            delay: a.delayMinutes || 0
          }))
        };
      });
      return result;
    }

    // 3) Refresh & render logic stays the same
    async function refreshData() {
      const data = await fetchBusData();
      renderBusLines(data);
      updateLastUpdated();
    }

    function toggleAutoRefresh() {
      const cb = document.getElementById('autoRefresh');
      if (cb.checked) {
        autoRefreshInterval = setInterval(refreshData, 30000);
        refreshData();
      } else if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    }

    // 4) Initialization
    document.addEventListener('DOMContentLoaded', () => {
      refreshData();
      updateStatus('online');
    });
  </script>
</body>
</html>
